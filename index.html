<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de PDF para Tareas UASD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        form { display: flex; flex-direction: column; gap: 10px; }
        label { font-weight: bold; }
        input, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #imagenes-preview { display: flex; flex-wrap: wrap; gap: 10px; }
        .preview-img { max-width: 200px; height: auto; border: 1px solid #ddd; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .preview-img { max-width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Generador de PDF para Tareas UASD</h1>
    <form id="formulario">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre">

        <label for="matricula">Matr√≠cula:</label>
        <input type="text" id="matricula">

        <label for="profesor">Profesor:</label>
        <input type="text" id="profesor">

        <label for="seccion">Secci√≥n:</label>
        <input type="text" id="seccion">

        <label for="asignatura">Asignatura:</label>
        <input type="text" id="asignatura">

        <label for="tema">Tema (puede ser largo, usa enters):</label>
        <textarea id="tema" rows="4"></textarea>

        <label for="nombreTrabajo">Nombre del trabajo (para el archivo PDF):</label>
        <input type="text" id="nombreTrabajo" placeholder="Ej: Massiel-Fisica-Proyecto">

        <div style="font-size: 14px; color: #555;">
            üóúÔ∏è <strong>Comprimir PDF (si pesa mucho):</strong>
            <a href="https://www.ilovepdf.com/es/comprimir_pdf" target="_blank" style="display: inline-block; margin-left: 8px; padding: 5px 12px; background-color: #2196F3; color: white; border-radius: 4px; text-decoration: none; font-size: 13px;">Click ac√°</a>
        </div>

        <label for="imagenes">Agregar Im√°genes (puedes agregar una por una o m√∫ltiples):</label>
        <input type="file" id="imagenes" multiple accept="image/*">

        <div id="imagenes-preview"></div>

        <button type="button" id="generar-pdf">Generar y Descargar PDF</button>
    </form>

    <script>
        const imagenesInput = document.getElementById('imagenes');
        const previewDiv = document.getElementById('imagenes-preview');
        let images = []; // { data: base64dataURL, file: File }

        imagenesInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imgData = event.target.result;
                    images.push({ data: imgData, file: file });
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.classList.add('preview-img');
                    previewDiv.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
            imagenesInput.value = '';
        });

        /**
         * Lee la orientaci√≥n EXIF directamente de los bytes del archivo JPEG.
         * No depende de librer√≠as externas. Devuelve 1-8, o 1 si no encuentra.
         */
        function readExifOrientation(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const view = new DataView(e.target.result);
                        if (view.getUint16(0, false) !== 0xFFD8) { resolve(1); return; }
                        let offset = 2;
                        while (offset < view.byteLength) {
                            const marker = view.getUint16(offset, false);
                            offset += 2;
                            if (marker === 0xFFE1) {
                                if (view.getUint32(offset + 2, false) !== 0x45786966) { resolve(1); return; }
                                const little = view.getUint16(offset + 10, false) === 0x4949;
                                offset += 10;
                                const ifdOffset = view.getUint32(offset + 4, little);
                                const entries = view.getUint16(offset + ifdOffset, little);
                                for (let i = 0; i < entries; i++) {
                                    const tag = view.getUint16(offset + ifdOffset + 2 + i * 12, little);
                                    if (tag === 0x0112) {
                                        resolve(view.getUint16(offset + ifdOffset + 2 + i * 12 + 8, little));
                                        return;
                                    }
                                }
                                resolve(1); return;
                            } else if ((marker & 0xFF00) !== 0xFF00) {
                                break;
                            } else {
                                offset += view.getUint16(offset, false);
                            }
                        }
                        resolve(1);
                    } catch { resolve(1); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        /**
         * Obtiene la imagen con orientaci√≥n corregida usando createImageBitmap
         * con { imageOrientation: 'none' } para evitar que el browser auto-corrija,
         * y luego aplica la transformaci√≥n correcta en canvas.
         */
        async function getCorrectImageDataURL(file, exifOrientation) {
            let bitmap;
            try {
                // imageOrientation:'none' = p√≠xeles crudos, sin auto-correcci√≥n del browser
                bitmap = await createImageBitmap(file, { imageOrientation: 'none' });
            } catch {
                // Fallback para browsers sin soporte de imageOrientation
                const url = URL.createObjectURL(file);
                bitmap = await loadImage(url);
                URL.revokeObjectURL(url);
            }

            const w = bitmap.width || bitmap.naturalWidth;
            const h = bitmap.height || bitmap.naturalHeight;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            if ([5, 6, 7, 8].includes(exifOrientation)) {
                canvas.width = h;
                canvas.height = w;
            } else {
                canvas.width = w;
                canvas.height = h;
            }

            ctx.save();
            switch (exifOrientation) {
                case 2: ctx.translate(w, 0);  ctx.scale(-1, 1);             break;
                case 3: ctx.translate(w, h);  ctx.rotate(Math.PI);          break;
                case 4: ctx.translate(0, h);  ctx.scale(1, -1);             break;
                case 5: ctx.translate(h, 0);  ctx.rotate(0.5 * Math.PI);   ctx.scale(1, -1); break;
                case 6: ctx.translate(h, 0);  ctx.rotate(0.5 * Math.PI);   break;
                case 7: ctx.translate(0, w);  ctx.rotate(-0.5 * Math.PI);  ctx.scale(1, -1); break;
                case 8: ctx.translate(0, w);  ctx.rotate(-0.5 * Math.PI);  break;
                default: break;
            }
            ctx.drawImage(bitmap, 0, 0);
            ctx.restore();

            return canvas.toDataURL('image/jpeg', 0.92);
        }

        async function crearPDF() {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) { alert('Error: jsPDF no est√° cargado.'); return; }

            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const center = pageWidth / 2;
            let y = 40;

            try {
                const logo = await loadImage('uasd.png');
                const logoWidth = 90;
                const aspectRatio = logo.naturalWidth / logo.naturalHeight;
                const logoHeight = logoWidth / aspectRatio;
                const logoX = (pageWidth - logoWidth) / 2;
                pdf.addImage(logo, 'PNG', logoX, 20, logoWidth, logoHeight);
                y = 20 + logoHeight + 10;
            } catch (err) {
                console.warn('No se pudo cargar el logo uasd.png:', err);
                y = 40;
            }

            pdf.setFont('times');
            pdf.setFontSize(14);

            function escribir(label, value) {
                if (!value || value.trim() === '') return;
                pdf.text(`${label}: ${value}`, center, y, { align: 'center' });
                y += 10;
            }

            escribir('Nombre', document.getElementById('nombre').value);
            escribir('Matr√≠cula', document.getElementById('matricula').value);
            escribir('Profesor', document.getElementById('profesor').value);
            escribir('Secci√≥n', document.getElementById('seccion').value);
            escribir('Asignatura', document.getElementById('asignatura').value);

            const temaValue = document.getElementById('tema').value;
            if (temaValue && temaValue.trim() !== '') {
                pdf.setFontSize(13);
                const lineas = pdf.splitTextToSize('Tema: ' + temaValue, 170);
                pdf.text(lineas, center, y, { align: 'center' });
                y += lineas.length * 7;
            }

            for (let imgEntry of images) {
                try {
                    pdf.addPage();

                    // 1. Leer orientaci√≥n EXIF directo de los bytes (sin browser en medio)
                    const orientation = await readExifOrientation(imgEntry.file);

                    // 2. Corregir orientaci√≥n en canvas usando p√≠xeles crudos
                    const correctedDataURL = await getCorrectImageDataURL(imgEntry.file, orientation);

                    // 3. Cargar imagen corregida y a√±adir al PDF
                    const correctedImg = await loadImage(correctedDataURL);
                    let imgWidth = correctedImg.naturalWidth;
                    let imgHeight = correctedImg.naturalHeight;

                    const maxWidth = 180;
                    const maxHeight = 250;
                    const ratio = imgWidth / imgHeight;

                    if (imgWidth > maxWidth) { imgWidth = maxWidth; imgHeight = imgWidth / ratio; }
                    if (imgHeight > maxHeight) { imgHeight = maxHeight; imgWidth = imgHeight * ratio; }

                    const imgX = (pageWidth - imgWidth) / 2;
                    const imgY = (pageHeight - imgHeight) / 2;

                    pdf.addImage(correctedImg, 'JPEG', imgX, imgY, imgWidth, imgHeight);
                } catch (err) {
                    console.error('Error al agregar imagen:', err);
                }
            }

            let nombreArchivo = document.getElementById('nombreTrabajo').value.trim();
            if (!nombreArchivo) nombreArchivo = 'tarea_uasd';
            nombreArchivo = nombreArchivo.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s-]/g, '_');
            if (!nombreArchivo.toLowerCase().endsWith('.pdf')) nombreArchivo += '.pdf';

            try {
                pdf.save(nombreArchivo);
            } catch (err) {
                console.error('Error al descargar PDF:', err);
                alert('No se pudo descargar el PDF. Revisa la consola.');
            }
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`No se pudo cargar: ${src}`));
                img.src = src;
                setTimeout(() => reject(new Error('Timeout')), 5000);
            });
        }

        document.getElementById('generar-pdf').addEventListener('click', async () => {
            await crearPDF();
        });
    </script>
</body>
</html>